<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ACCT 922 — Final Presentation Date (Fall 2025)</title>
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    :root{
      /* Light theme */
      --bg:#f8fafc; --card:#ffffff; --ink:#0f172a; --muted:#475569; --accent:#6b4eff; --border:#e5e7eb;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    .wrap{max-width:1100px;margin:32px auto;padding:0 20px}
    header{display:grid;gap:10px;margin-bottom:18px}
    h1{font-weight:800;letter-spacing:0.2px;margin:0;font-size:clamp(24px,2.4vw,36px)}
    .subtitle{color:var(--muted);font-size:1.05rem}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 6px 24px rgba(15,23,42,.06);overflow:hidden}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:20px}
    @media (max-width: 960px){.grid{grid-template-columns:1fr;}}
    .section{padding:16px}
    .section h2{margin:0 0 8px 0;font-size:1.05rem;font-weight:700;color:#334155}
    .muted{color:var(--muted)}
    iframe{width:100%;height:720px;border:0}
    .toolbar{display:flex;gap:10px;align-items:center;justify-content:space-between;padding:12px 16px;border-top:1px solid var(--border);background:#f3f4f6}
    .btn{appearance:none;border:1px solid var(--border);background:#ffffff;color:#111827;border-radius:10px;padding:9px 12px;font-weight:600;cursor:pointer;transition:.2s transform,.2s box-shadow}
    .btn:active{transform:translateY(1px)}
    .small{font-size:.9rem;color:var(--muted)}
    .chartWrap{padding:8px 12px 16px 12px}
    canvas{width:100% !important;height:380px !important}
    .note{font-size:.95rem;color:var(--muted);line-height:1.55}
    .pill{display:inline-block;background:#eef2ff;color:#3730a3;border:1px solid #e0e7ff;padding:4px 10px;border-radius:999px;font-size:.85rem;margin-right:8px}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <h1>ACCT 922 — Final Presentation Date (Fall 2025)</h1>
      <p class="subtitle">Please select your preferred presentation date. Presentations are <strong>10 minutes</strong>, followed by <strong>5 minutes</strong> of Q&amp;A.</p>
      <p class="note"><span class="pill">Dates</span> <strong>Monday, November 17</strong> or <strong>Wednesday, November 19</strong>.<br/>Choose <em>one</em> option below. If both dates work, select <em>“Either date works.”</em></p>
    </header>

    <div class="grid">
      <!-- Left: the Google Form -->
      <div class="card">
        <iframe src="https://docs.google.com/forms/d/e/1FAIpQLSdV8foHKr1TfV8oSOcROai4MwfXtM5YzxrVgR-6EIDIHKZF2A/viewform?embedded=true" title="ACCT 922 Form" allow="clipboard-write *;"></iframe>
        <div class="toolbar">
          <div class="small">Submit above, then refresh the results on the right.</div>
          <button class="btn" id="refreshBoth">Refresh live results</button>
        </div>
      </div>

      <!-- Right: Live results chart -->
      <div class="card">
        <div class="section">
          <h2>Live Poll Results</h2>
          <p class="muted" id="resultMeta">Fetching latest CSV…</p>
        </div>
        <div class="chartWrap">
          <canvas id="resultsChart" aria-label="Bar chart of poll results" role="img"></canvas>
        </div>
        <div class="toolbar">
          <div class="small" id="updatedAt">Last updated —</div>
          <div>
            <button class="btn" id="refreshBtn">Refresh</button>
          </div>
        </div>
      </div>
    </div>

    <p class="note" style="margin-top:18px">This page embeds the Google Form and visualizes the responses from its published CSV (<code>File &gt; Share &gt; Publish to the web</code>). Click <strong>Refresh</strong> to grab the newest CSV and update the chart immediately.</p>
  </div>

  <script>
    const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSNunski5yKvFXexjpUrN7gPT5tQPcMiIUaaq_-wm3GjqAQTrrupDw1nK_oxOMQF6xcR_Dn0OWzEREq/pub?gid=1250869048&single=true&output=csv';

    const state = { raw: [], header: [], counts: new Map(), chart: null, labelColumn: null };

    function cacheBust(url){
      const u = new URL(url);
      u.searchParams.set('_', Date.now().toString());
      return u.toString();
    }

    function looksAggregated(headers){
      const lower = headers.map(h => (h||'').toLowerCase().trim());
      const optionIdx = lower.findIndex(h => /^(option|choice|date)/.test(h));
      const votesIdx = lower.findIndex(h => /(votes|count|responses?)/.test(h));
      return optionIdx !== -1 && votesIdx !== -1 ? { optionIdx, votesIdx } : null;
    }

    function detectChoiceColumn(headers){
      const lower = headers.map(h => h.toLowerCase());
      let idx = lower.findIndex(h => /(preferred|date|option|choice)/.test(h) && !/timestamp/.test(h));
      if(idx !== -1) return idx;
      for(let i=lower.length-1;i>=0;i--){
        if(!/timestamp/.test(lower[i]) && lower[i].trim()!== '') return i;
      }
      return Math.max(0, headers.length-1);
    }

    async function loadCsv(){
      const res = await fetch(cacheBust(CSV_URL), {cache:'no-store'});
      if(!res.ok) throw new Error('Network error '+res.status);
      const text = await res.text();
      return new Promise((resolve)=>{
        Papa.parse(text, {
          header: true,
          skipEmptyLines: true,
          complete: (results)=> resolve(results)
        });
      });
    }

    function computeCounts(rows, headers){
      const agg = looksAggregated(headers);
      const counts = new Map();
      if(agg){
        state.labelColumn = headers[agg.optionIdx];
        for(const row of rows){
          const keys = Object.keys(row);
          const label = row[keys[agg.optionIdx]]?.trim();
          const val = parseInt(String(row[keys[agg.votesIdx]]||'').replace(/[^\d-]/g,''),10);
          if(label && Number.isFinite(val)) counts.set(label, val);
        }
        return counts;
      }
      // Fallback: one response per row
      const choiceIdx = detectChoiceColumn(headers);
      state.labelColumn = headers[choiceIdx];
      for(const row of rows){
        const keys = Object.keys(row);
        const label = row[keys[choiceIdx]]?.trim();
        if(!label) continue;
        counts.set(label, (counts.get(label)||0)+1);
      }
      return counts;
    }

    function renderChart(){
      const labels = Array.from(state.counts.keys());
      const data = Array.from(state.counts.values());

      const ds = { label: 'Votes Registered', data, borderWidth: 1 };
      const ctx = document.getElementById('resultsChart').getContext('2d');
      if(state.chart){ state.chart.destroy(); }
      state.chart = new Chart(ctx, {
        type: 'bar',
        data: { labels, datasets: [ds] },
        options: {
          maintainAspectRatio: false,
          scales: { y: { beginAtZero: true, ticks: { precision:0 } } },
          plugins: {
            legend: { display: false },
            tooltip: { callbacks: { label: (ctx)=> `${ctx.parsed.y} vote${ctx.parsed.y===1?'':'s'}` } },
            title: { display: true, text: state.labelColumn || 'Responses' }
          }
        }
      });
    }

    async function refresh(){
      const start = performance.now();
      const meta = document.getElementById('resultMeta');
      meta.textContent = 'Fetching latest CSV…';
      try{
        const { data, meta: m } = await loadCsv();
        state.raw = data; state.header = m.fields || Object.keys(data[0]||{});
        state.counts = computeCounts(state.raw, state.header);
        renderChart();
        const took = Math.max(1, Math.round(performance.now()-start));
        document.getElementById('updatedAt').textContent = `Last updated — ${new Date().toLocaleString()} • ${took} ms`;
        const total = Array.from(state.counts.values()).reduce((a,b)=>a+b,0);
        meta.textContent = `${total} total votes registered`;
      }catch(err){
        console.error(err);
        meta.textContent = 'Failed to fetch CSV. Please try again.';
      }
    }

    document.getElementById('refreshBtn').addEventListener('click', refresh);
    document.getElementById('refreshBoth').addEventListener('click', refresh);
    
    // Auto-refresh on first load
    refresh();
  </script>
</body>
</html>
