<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>ACCT 922 — Final Presentation Poll (Fall 2025)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet" />
  <style>
    :root {
      --bg: #0f172a0d;
      --card: #ffffff;
      --text: #0f172a;
      --muted: #64748b;
      --brand: #6366f1;
      --brand-weak: #eef2ff;
      --ring: 0 0 0 6px rgba(99,102,241,.15);
      --radius: 18px;
      --shadow: 0 10px 30px rgba(2, 6, 23, .08);
      --maxw: 1100px;
    }
    html, body { height: 100%; }
    body {
      margin: 0;
      background: linear-gradient(180deg, #f8fafc, #eef2f7);
      color: var(--text);
      font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    /* Page header */
    header.page {
      position: sticky; top: 0; z-index: 10;
      backdrop-filter: blur(6px);
      background: rgba(255,255,255,.75);
      border-bottom: 1px solid #e5e7eb;
    }
    .nav {
      max-width: var(--maxw);
      margin: 0 auto;
      padding: 16px 18px;
      display: flex;
      align-items: center;
      gap: 12px;
    }
    .dot {
      width: 10px; height: 10px; border-radius: 9999px; background: var(--brand);
      box-shadow: 0 0 0 6px rgba(99,102,241,.15);
    }
    h1 { font-size: 18px; margin: 0; font-weight: 600; letter-spacing: .2px; }
    .wrap {
      max-width: var(--maxw);
      margin: 22px auto;
      padding: 0 18px 28px;
      display: grid;
      gap: 22px;
    }
    @media (min-width: 980px) {
      .wrap { grid-template-columns: 1fr 1fr; }
    }
    .card {
      background: var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
      border: 1px solid #eaeef3;
    }
    .card > header {
      background: linear-gradient(0deg, #fff, #fff);
      border: none;
      padding: 16px 18px;
    }
    .card h2 { margin: 0; font-size: 16px; font-weight: 600; }
    .content { padding: 16px 18px 20px; }
    .meta { font-size: 12px; color: var(--muted); margin-top: 6px; }
    .toolbar { display: flex; align-items: center; gap: 10px; margin-bottom: 12px; }
    .btn {
      cursor: pointer; border: 0; padding: 10px 12px; border-radius: 12px;
      background: var(--brand-weak); color: var(--text); font-weight: 500;
      transition: transform .06s ease, box-shadow .1s ease, background .2s ease;
    }
    .btn:hover { transform: translateY(-1px); box-shadow: var(--shadow); }
    .btn:active { transform: translateY(0); box-shadow: none; }
    .chartShell {
      background: #fbfbfe; border: 1px solid #eceef8; border-radius: 14px;
      padding: 14px; min-height: 280px;
    }
    #resultsChart { width: 100%; height: 420px; display: block; border-radius: 10px; }
    iframe {
      width: 100%; border: 0; background: #fff; border-radius: 14px;
      min-height: 1200px;
    }
    .footNote { padding: 10px 18px 16px; font-size: 12px; color: var(--muted); }
    .lede { max-width: var(--maxw); margin: 12px auto 0; padding: 0 18px; color: var(--muted); }
  </style>
</head>
<body>
  <header class="page">
    <div class="nav">
      <div class="dot" aria-hidden="true"></div>
      <h1>ACCT 922 — Final Presentation Poll</h1>
    </div>
  </header>

  <p class="lede">
    Please select your preferred presentation date. Presentations are
    <strong>10 minutes</strong>, followed by <strong>5 minutes</strong> of Q&amp;A.
    Dates: <strong>Monday, November 17</strong> or <strong>Wednesday, November 19</strong>.
    Choose <strong>one</strong> option below. If both dates work, select “Either date works.”
  </p>

  <main class="wrap">
    <!-- Live chart -->
    <section class="card">
      <header><h2>Live Results</h2></header>
      <div class="content">
        <div class="toolbar">
          <button id="refreshBtn" class="btn" title="Force refresh">Refresh chart</button>
          <span class="meta" id="lastRef">Last refresh: never</span>
        </div>

        <div class="chartShell">
          <canvas id="resultsChart"></canvas>
        </div>
      </div>
    </section>

    <!-- Form -->
    <section class="card">
      <header><h2>Survey</h2></header>
      <div class="content">
        <iframe
          src="https://docs.google.com/forms/d/e/1FAIpQLSdV8foHKr1TfV8oSOcROai4MwfXtM5YzxrVgR-6EIDIHKZF2A/viewform?embedded=true"
          allowfullscreen
        >Loading…</iframe>
      </div>
      <div class="footNote">Tip: if your form is longer/shorter, adjust the iframe height in the HTML.</div>
    </section>
  </main>

  <!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // --- CONFIG ---
  const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSNunski5yKvFXexjpUrN7gPT5tQPcMiIUaaq_-wm3GjqAQTrrupDw1nK_oxOMQF6xcR_Dn0OWzEREq/pub?gid=1250869048&single=true&output=csv';
  const lastRefEl = document.getElementById('lastRef');
  const refreshBtn = document.getElementById('refreshBtn');
  const POLL_MS = 10000; // 10s

  // Canonical labels + aliases -> keeps bar order stable
  const LABEL_ORDER = [
    'Monday, November 17',
    'Wednesday, November 19',
    'Either date works'
  ];
  const ALIASES = new Map([
    [/^mon(day)?[, ]*nov(ember)?\.?\s*17/i, 'Monday, November 17'],
    [/^wed(nesday)?[, ]*nov(ember)?\.?\s*19/i, 'Wednesday, November 19'],
    [/either/i, 'Either date works'],
  ]);

  // Anti-flicker settings
  const HISTORY_WINDOW = 3;         // median over last 3 pulls
  const ENFORCE_MONOTONIC = true;   // counts cannot go down per label

  let chart;
  let inFlight; // AbortController
  const history = []; // array of { counts: Map<label, number>, total, ts }
  const lastMaxSeen = new Map(); // per-label maximum (for monotonic)

  // --- FETCH (overlap-safe, cache-busted) ---
  async function fetchCSV(url) {
    if (inFlight) inFlight.abort();
    inFlight = new AbortController();
    const u = new URL(url);
    u.searchParams.set('cb', Date.now());

    const res = await fetch(u.toString(), { cache: 'no-store', signal: inFlight.signal });
    if (!res.ok) throw new Error(`CSV fetch failed: HTTP ${res.status}`);
    return res.text();
  }

  // --- CSV PARSER (robust quotes) ---
  function splitCSV(line) {
    const out = [];
    let cur = '', q = false;
    for (let i = 0; i < line.length; i++) {
      const ch = line[i];
      if (ch === '"') {
        const next = line[i + 1];
        if (q && next === '"') { cur += '"'; i++; continue; } // escaped quote
        q = !q; continue;
      }
      if (ch === ',' && !q) { out.push(cur); cur = ''; continue; }
      cur += ch;
    }
    out.push(cur);
    return out.map(s => s.trim());
  }

  function parseCSV(text) {
    const lines = text.replace(/\r\n?/g, '\n').split('\n').filter(l => l.trim().length);
    if (!lines.length) return { labels: [], values: [] };

    const header = splitCSV(lines[0]);
    const rows = lines.slice(1).map(splitCSV);

    const idxLabel = header.findIndex(c => /option|choice|date/i.test(c));
    const idxValue = header.findIndex(c => /vote|count|responses?|tally|#/i.test(c));
    const li = idxLabel >= 0 ? idxLabel : 0;
    const vi = idxValue >= 0 ? idxValue : 1;

    // normalize labels via aliases
    const norm = (s='') => {
      for (const [re, target] of ALIASES) if (re.test(s)) return target;
      return s;
    };

    // aggregate counts by canonical label
    const counts = new Map(LABEL_ORDER.map(l => [l, 0]));
    for (const parts of rows) {
      const rawL = parts[li] ?? '';
      const rawV = parts[vi] ?? '0';
      const val = Number(String(rawV).replace(/[^0-9.-]/g, '')) || 0;
      const label = norm(rawL);
      if (!counts.has(label)) counts.set(label, 0); // allow unexpected label
      counts.set(label, (counts.get(label) || 0) + val);
    }

    // build ordered arrays (unknown labels appended)
    const ordered = [...LABEL_ORDER, ...[...counts.keys()].filter(k => !LABEL_ORDER.includes(k))];
    return {
      labels: ordered,
      values: ordered.map(l => counts.get(l) || 0),
      counts
    };
  }

  // --- STABILIZE (median + monotonic) ---
  function median(nums) {
    const a = [...nums].sort((x, y) => x - y);
    const m = Math.floor(a.length / 2);
    return a.length % 2 ? a[m] : (a[m - 1] + a[m]) / 2;
  }

  function stabilize(countsMap) {
    // push to rolling history
    const snapshot = { counts: new Map(countsMap), total: sumCounts(countsMap), ts: Date.now() };
    history.push(snapshot);
    if (history.length > HISTORY_WINDOW) history.shift();

    // median per label over window
    const labels = [...countsMap.keys()];
    const medCounts = new Map();
    for (const l of labels) {
      const series = history.map(h => h.counts.get(l) || 0);
      let v = Math.round(median(series));
      if ( ENFORCE_MONOTONIC ) {
        const prevMax = lastMaxSeen.get(l) ?? 0;
        if (v < prevMax) v = prevMax;
        lastMaxSeen.set(l, v);
      }
      medCounts.set(l, v);
    }
    return medCounts;
  }

  function sumCounts(map) {
    let t = 0; for (const v of map.values()) t += v; return t;
  }

  // --- CHART ---
  function ensureChart() {
    if (chart) return chart;
    const ctx = document.getElementById('resultsChart').getContext('2d');
    chart = new Chart(ctx, {
      type: 'bar',
      data: { labels: [], datasets: [{ label: 'Responses', data: [] }] },
      options: {
        responsive: true,
        animation: false,
        plugins: { legend: { display: false }, tooltip: { mode: 'index', intersect: false } },
        scales: { y: { beginAtZero: true, ticks: { precision: 0 } } }
      }
    });
    return chart;
  }

  function updateChartFromMap(map) {
    const ordered = [...LABEL_ORDER, ...[...map.keys()].filter(k => !LABEL_ORDER.includes(k))];
    const ch = ensureChart();
    ch.data.labels = ordered;
    ch.data.datasets[0].data = ordered.map(l => map.get(l) || 0);
    ch.update();
  }

  // --- REFRESH LOOP ---
  async function refreshChartData() {
    try {
      const csv = await fetchCSV(CSV_URL);
      const parsed = parseCSV(csv);
      if (!parsed.labels.length) throw new Error('No rows parsed.');
      const stable = stabilize(parsed.counts);
      updateChartFromMap(stable);
      lastRefEl.textContent = 'Last refresh: ' + new Date().toLocaleTimeString();
    } catch (err) {
      if (err.name === 'AbortError') return;
      lastRefEl.textContent = 'Last refresh failed: ' + err.message + ' — ' + new Date().toLocaleTimeString();
    }
  }

  // Pause polling when tab hidden (reduces race/wobble)
  let timer = null;
  function startTimer() { if (!timer) timer = setInterval(refreshChartData, POLL_MS); }
  function stopTimer()  { if (timer) { clearInterval(timer); timer = null; } }

  refreshBtn.addEventListener('click', refreshChartData);
  window.addEventListener('load', () => { setTimeout(refreshChartData, 300); startTimer(); });
  document.addEventListener('visibilitychange', () => {
    if (document.hidden) { stopTimer(); }
    else { refreshChartData(); startTimer(); }
  });
</script>


</body>
</html>
